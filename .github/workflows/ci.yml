name: Security Scan

on:
  push:
    branches: ['*']
  pull_request:
    branches: [main]
  # Permet de lancer manuellement
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
        uses: actions/checkout@v4
      - name: ðŸ“¦ Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
      - run: pip install -r requirements.txt
      - run: python app.py
  # ============================================
  # JOB 2 : TEST - ExÃ©cuter les tests
  # ============================================
  test:
    # Ce job a besoin que "build" soit terminÃ©
    needs: build
    runs-on: ubuntu-latest
    steps:
        uses: actions/checkout@v4
      - name: ðŸ“¦ Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      - run: python app_test.py
      - name: âœ… Tests passed
        run: echo "All tests passed successfully!"
  # ============================================
  # JOB 3 : DOCKER - Construire l'image
  # ============================================
  docker:
    needs: test
    runs-on: ubuntu-latest
    steps:
        uses: actions/checkout@v4
      - name: ðŸ³ Build Docker image
        run: |
          docker build -t exam1:${{ github.sha }} .
          docker build -t exam1:latest .
      - name: ðŸ” Verify image
        run: docker images exam1
      - name: ðŸ§ª Test container
        run: |
          docker run -d -p 5000:5000 --name test-container exam1:latest
          sleep 5
          curl --fail http://localhost:5000/health
          docker stop test-container
          docker rm test-container
      - name: âœ… Docker build successful
        run: echo "Docker image built and tested successfully!"

  # ============================================
  # JOB 4 : SUMMARY - RÃ©sumÃ© final
  # ============================================
  summary:
    needs: [build, test, docker]
    runs-on: ubuntu-latest
    if: always()  # S'exÃ©cute mÃªme si les jobs prÃ©cÃ©dents Ã©chouent
    steps:
      - name: ðŸ“Š Pipeline Summary
        run: |
          echo "================================"
          echo "       PIPELINE SUMMARY         "
          echo "================================"
          echo "Build:  ${{ needs.build.result }}"
          echo "Test:   ${{ needs.test.result }}"
          echo "Docker: ${{ needs.docker.result }}"
          echo "================================"


  # ===========================================
  # JOB 1 : GÃ©nÃ©rer le SBOM
  # ===========================================
  sbom:
    name: ðŸ“¦ Generate SBOM
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-python@v6
        with:
          node-version: '3.11'

      - name: ðŸ“š Install dependencies
        run: pip install -r requirements.txt

      - name: ðŸ”§ Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: ðŸ“‹ Generate SBOM (CycloneDX)
        run: syft . -o cyclonedx-json > sbom.json

      - name: ðŸ“¤ Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json

  # ===========================================
  # JOB 2 : Scanner avec Grype
  # ===========================================
  grype-scan:
    name: ðŸ” Grype Vulnerability Scan
    needs: sbom
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Download SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom

      - name: ðŸ”§ Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: ðŸ” Scan vulnerabilities
        run: grype sbom:sbom.json -o table

      - name: ðŸ“Š Generate JSON report
        run: grype sbom:sbom.json -o json > grype-results.json

      - name: ðŸ“¤ Upload Grype results
        uses: actions/upload-artifact@v4
        with:
          name: grype-results
          path: grype-results.json

      - name: ðŸš¨ Check for Critical vulnerabilities
        run: |
          CRITICAL=$(cat grype-results.json | jq '[.matches[] | select(.vulnerability.severity=="Critical")] | length')
          echo "Critical vulnerabilities: $CRITICAL"
          if [ "$CRITICAL" -gt 0 ]; then
            echo "Critical vulnerabilities found!"
            exit 1
          fi
          echo "No critical vulnerabilities"
  # ===========================================
  # JOB 4 : RÃ©sumÃ©
  # ===========================================
  summary:
    name: ðŸ“Š Security Summary
    needs: [sbom, grype-scan]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸ” Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM Generation | ${{ needs.sbom.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Grype Scan | ${{ needs.grype-scan.result }} |" >> $GITHUB_STEP_SUMMARY
